#!/usr/bin/env python
"""
Script de pruebas para la integraci√≥n completa con SUNAT
Ejecutar con: python test_sunat_integration.py
"""

import requests
import json
import os
import sys
import time
from datetime import datetime

# Configuraci√≥n
BASE_URL = "http://localhost:8000"
API_BASE = f"{BASE_URL}/api/v1"

def test_health_check():
    """Prueba el endpoint de salud"""
    print("üîç Probando endpoint de salud...")
    
    try:
        response = requests.get(f"{BASE_URL}/health/")
        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ Health check exitoso: {data['message']}")
            
            # Verificar caracter√≠sticas SUNAT
            features = data.get('features', {})
            print(f"   üîß Generaci√≥n XML: {'‚úÖ' if features.get('xml_generation') else '‚ùå'}")
            print(f"   üîê Firma digital: {'‚úÖ' if features.get('digital_signature') else '‚ùå'}")
            print(f"   üì° Integraci√≥n SUNAT: {'‚úÖ' if features.get('sunat_integration') else '‚ùå'}")
            print(f"   üìÑ Procesamiento CDR: {'‚úÖ' if features.get('cdr_processing') else '‚ùå'}")
            
            return True
        else:
            print(f"‚ùå Health check fall√≥: {response.status_code}")
            return False
    except Exception as e:
        print(f"‚ùå Error en health check: {str(e)}")
        return False

def create_test_comprobante():
    """Crear un comprobante de prueba para SUNAT"""
    print("\nüîç Creando comprobante de prueba...")
    
    # Generar n√∫mero √∫nico basado en timestamp
    timestamp = str(int(time.time()))[-6:]
    
    test_data = {
        "serie": "F001",
        "numero": timestamp,  # N√∫mero √∫nico
        "fechaEmision": "2025-01-01",
        "horaEmision": "10:30:00",
        "tipoDocumento": "01",
        "moneda": "PEN",
        "formaPago": "Contado",
        "totalGravado": 156.78,
        "totalIGV": 28.22,
        "totalPrecioVenta": 185.00,
        "totalImportePagar": 185.00,
        "emisor": {
            "ruc": "20607599727",
            "razonSocial": "INSTITUTO INTERNACIONAL DE SOFTWARE S.A.C.",
            "nombreComercial": "INSTITUTO INTERNACIONAL DE SOFTWARE S.A.C.",
            "ubigeo": "140101",
            "direccion": "8 DE OCTUBRE N 123 - LAMBAYEQUE - LAMBAYEQUE - LAMBAYEQUE",
            "departamento": "LAMBAYEQUE",
            "provincia": "LAMBAYEQUE",
            "distrito": "LAMBAYEQUE",
            "codigoPais": "PE",
            "correo": "test@institutoisi.com"
        },
        "cliente": {
            "numeroDoc": "20000000001",  # RUC de pruebas SUNAT
            "razonSocial": "EMPRESA DE PRUEBAS SUNAT",
            "tipoDoc": "6",
            "ubigeo": "130101",
            "direccion": "AV. PRUEBAS 123 - LIMA",
            "departamento": "LIMA",
            "provincia": "LIMA",
            "distrito": "LIMA",
            "codigoPais": "PE",
            "correo": "pruebas@sunat.gob.pe"
        },
        "items": [
            {
                "id": "1",
                "cantidad": 1,
                "unidadMedida": "NIU",
                "descripcion": "PRODUCTO DE PRUEBA SUNAT",
                "valorUnitario": 156.78,
                "precioVentaUnitario": 185.00,
                "valorTotal": 156.78,
                "igv": 28.22,
                "codigoProducto": "PROD001",
                "codigoProductoSUNAT": "PROD001",
                "codigoTipoPrecio": "01",
                "tipoAfectacionIGV": "10",
                "porcentajeIGV": 18,
                "codigoTributo": "1000",
                "nombreTributo": "IGV",
                "tipoTributo": "VAT",
                "unspsc": "10191509"
            }
        ]
    }
    
    try:
        response = requests.post(
            f"{API_BASE}/convert/",
            json=test_data,
            headers={"Content-Type": "application/json"}
        )
        
        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ Comprobante creado exitosamente")
            print(f"   ID: {data.get('comprobante_id')}")
            print(f"   XML: {data.get('xml_filename')}")
            print(f"   ZIP: {data.get('zip_filename')}")
            print(f"   Listo para SUNAT: {'‚úÖ' if data.get('can_send_to_sunat') else '‚ùå'}")
            return data.get('comprobante_id')
        else:
            print(f"‚ùå Error creando comprobante: {response.status_code}")
            print(f"   Respuesta: {response.text}")
            return None
    except Exception as e:
        print(f"‚ùå Error: {str(e)}")
        return None

def test_send_to_sunat(comprobante_id):
    """Probar env√≠o a SUNAT"""
    print(f"\nüîç Enviando comprobante {comprobante_id} a SUNAT...")
    
    try:
        response = requests.post(f"{API_BASE}/send-to-sunat/{comprobante_id}/")
        
        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ Respuesta de SUNAT recibida")
            print(f"   √âxito: {'‚úÖ' if data.get('success') else '‚ùå'}")
            print(f"   Estado: {data.get('estado')}")
            print(f"   Mensaje: {data.get('message', 'Sin mensaje')}")
            
            if data.get('ticket'):
                print(f"   üé´ Ticket: {data.get('ticket')}")
            
            if data.get('cdr_info'):
                cdr_info = data.get('cdr_info')
                print(f"   üìÑ CDR Info:")
                print(f"      C√≥digo: {cdr_info.get('response_code')}")
                print(f"      Descripci√≥n: {cdr_info.get('description')}")
            
            return data
        else:
            print(f"‚ùå Error enviando a SUNAT: {response.status_code}")
            print(f"   Respuesta: {response.text}")
            return None
    except Exception as e:
        print(f"‚ùå Error: {str(e)}")
        return None

def test_check_status(comprobante_id):
    """Probar consulta de estado"""
    print(f"\nüîç Consultando estado del comprobante {comprobante_id}...")
    
    try:
        response = requests.get(f"{API_BASE}/comprobante-status/{comprobante_id}/")
        
        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ Estado consultado")
            print(f"   Estado actual: {data.get('estado')}")
            print(f"   Ticket: {data.get('ticket', 'Sin ticket')}")
            
            if data.get('cdr_xml_path'):
                print(f"   üìÑ CDR disponible: {data.get('cdr_xml_path')}")
            
            if data.get('errores'):
                print(f"   ‚ùå Errores: {data.get('errores')}")
            
            return data
        else:
            print(f"‚ùå Error consultando estado: {response.status_code}")
            return None
    except Exception as e:
        print(f"‚ùå Error: {str(e)}")
        return None

def test_check_ticket_status(comprobante_id):
    """Probar consulta de ticket en SUNAT"""
    print(f"\nüîç Consultando ticket en SUNAT para comprobante {comprobante_id}...")
    
    try:
        response = requests.get(f"{API_BASE}/check-sunat-status/{comprobante_id}/")
        
        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ Consulta de ticket exitosa")
            print(f"   √âxito: {'‚úÖ' if data.get('success') else '‚ùå'}")
            print(f"   Estado: {data.get('estado')}")
            print(f"   Mensaje: {data.get('message', 'Sin mensaje')}")
            
            if data.get('cdr_info'):
                cdr_info = data.get('cdr_info')
                print(f"   üìÑ CDR Info:")
                print(f"      C√≥digo: {cdr_info.get('response_code')}")
                print(f"      Descripci√≥n: {cdr_info.get('description')}")
                if cdr_info.get('notes'):
                    print(f"      Notas: {', '.join(cdr_info.get('notes'))}")
            
            return data
        else:
            print(f"‚ùå Error consultando ticket: {response.status_code}")
            print(f"   Respuesta: {response.text}")
            return None
    except Exception as e:
        print(f"‚ùå Error: {str(e)}")
        return None

def test_download_cdr(comprobante_id):
    """Probar descarga de CDR"""
    print(f"\nüîç Intentando descargar CDR para comprobante {comprobante_id}...")
    
    try:
        response = requests.get(f"{API_BASE}/cdr/{comprobante_id}/")
        
        if response.status_code == 200:
            print(f"‚úÖ CDR descargado exitosamente")
            print(f"   Tama√±o: {len(response.content):,} bytes")
            print(f"   Content-Type: {response.headers.get('Content-Type')}")
            
            # Guardar CDR para inspecci√≥n
            cdr_filename = f"cdr_comprobante_{comprobante_id}.xml"
            with open(cdr_filename, 'wb') as f:
                f.write(response.content)
            print(f"   üíæ CDR guardado como: {cdr_filename}")
            
            return True
        elif response.status_code == 404:
            print(f"‚ö†Ô∏è  CDR no disponible a√∫n")
            return False
        else:
            print(f"‚ùå Error descargando CDR: {response.status_code}")
            return False
    except Exception as e:
        print(f"‚ùå Error: {str(e)}")
        return False

def test_sunat_dashboard():
    """Probar dashboard de estad√≠sticas SUNAT"""
    print(f"\nüîç Consultando dashboard SUNAT...")
    
    try:
        response = requests.get(f"{API_BASE}/sunat-dashboard/")
        
        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ Dashboard consultado exitosamente")
            
            stats = data.get('estadisticas', {})
            print(f"   üìä Estad√≠sticas:")
            print(f"      Total comprobantes: {stats.get('total_comprobantes')}")
            print(f"      Enviados a SUNAT: {stats.get('enviados_sunat')}")
            print(f"      Aceptados: {stats.get('aceptados_sunat')}")
            print(f"      Rechazados: {stats.get('rechazados_sunat')}")
            print(f"      Pendientes: {stats.get('pendientes_envio')}")
            print(f"      Tasa aceptaci√≥n: {stats.get('tasa_aceptacion')}%")
            
            print(f"   üìà Distribuci√≥n por estados:")
            for estado in data.get('estados_distribucion', []):
                print(f"      {estado.get('estado')}: {estado.get('count')}")
            
            return data
        else:
            print(f"‚ùå Error consultando dashboard: {response.status_code}")
            return None
    except Exception as e:
        print(f"‚ùå Error: {str(e)}")
        return None

def test_bulk_operations():
    """Probar operaciones en lote"""
    print(f"\nüîç Probando operaciones en lote...")
    
    # Crear m√∫ltiples comprobantes
    comprobante_ids = []
    for i in range(3):
        comprobante_id = create_test_comprobante()
        if comprobante_id:
            comprobante_ids.append(comprobante_id)
        time.sleep(1)  # Evitar duplicados por timestamp
    
    if not comprobante_ids:
        print("‚ùå No se pudieron crear comprobantes para prueba en lote")
        return False
    
    print(f"‚úÖ Comprobantes creados para lote: {comprobante_ids}")
    
    # Env√≠o en lote
    try:
        response = requests.post(
            f"{API_BASE}/bulk-send-sunat/",
            json={'comprobante_ids': comprobante_ids}
        )
        
        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ Env√≠o en lote completado")
            print(f"   Total procesados: {data.get('total_processed')}")
            print(f"   Exitosos: {data.get('successful')}")
            print(f"   Fallidos: {data.get('failed')}")
            
            return True
        else:
            print(f"‚ùå Error en env√≠o en lote: {response.status_code}")
            return False
    except Exception as e:
        print(f"‚ùå Error: {str(e)}")
        return False

def test_pending_tickets():
    """Probar verificaci√≥n de tickets pendientes"""
    print(f"\nüîç Verificando tickets pendientes...")
    
    try:
        response = requests.post(f"{API_BASE}/check-pending-tickets/")
        
        if response.status_code == 200:
            data = response.json()
            print(f"‚úÖ Verificaci√≥n de tickets completada")
            print(f"   Total verificados: {data.get('total_checked')}")
            
            for result in data.get('results', []):
                if result.get('success'):
                    print(f"   ‚úÖ Comprobante {result.get('comprobante_id')}: {result.get('estado')}")
                else:
                    print(f"   ‚ùå Comprobante {result.get('comprobante_id')}: {result.get('error')}")
            
            return True
        else:
            print(f"‚ùå Error verificando tickets: {response.status_code}")
            return False
    except Exception as e:
        print(f"‚ùå Error: {str(e)}")
        return False

def full_integration_test():
    """Prueba de integraci√≥n completa"""
    print("üöÄ INICIANDO PRUEBA DE INTEGRACI√ìN COMPLETA CON SUNAT")
    print("=" * 70)
    
    # 1. Health check
    if not test_health_check():
        print("\n‚ùå Health check fall√≥ - Abortando pruebas")
        return False
    
    # 2. Crear comprobante
    comprobante_id = create_test_comprobante()
    if not comprobante_id:
        print("\n‚ùå No se pudo crear comprobante - Abortando pruebas")
        return False
    
    # 3. Enviar a SUNAT
    send_result = test_send_to_sunat(comprobante_id)
    if not send_result:
        print("\n‚ùå Error enviando a SUNAT")
        return False
    
    # 4. Verificar estado
    status_result = test_check_status(comprobante_id)
    
    # 5. Si hay ticket, consultar estado en SUNAT
    if send_result.get('ticket'):
        print(f"\n‚è≥ Esperando 5 segundos antes de consultar ticket...")
        time.sleep(5)
        test_check_ticket_status(comprobante_id)
    
    # 6. Intentar descargar CDR
    test_download_cdr(comprobante_id)
    
    # 7. Dashboard
    test_sunat_dashboard()
    
    # 8. Operaciones en lote (opcional)
    print(f"\nüîç ¬øEjecutar pruebas en lote? (puede tomar tiempo) (s/n): ", end="")
    if input().lower() in ['s', 'si', 'y', 'yes']:
        test_bulk_operations()
        test_pending_tickets()
    
    print("\n" + "=" * 70)
    print("üéâ PRUEBA DE INTEGRACI√ìN COMPLETA FINALIZADA")
    print("=" * 70)
    
    return True

def main():
    """Funci√≥n principal"""
    print("üß™ TESTING INTEGRACI√ìN SUNAT")
    print("=" * 50)
    print("üìã Este script probar√°:")
    print("   1. ‚úÖ Health check con caracter√≠sticas SUNAT")
    print("   2. üìÑ Creaci√≥n de comprobante UBL 2.1")
    print("   3. üì° Env√≠o a SUNAT (ambiente beta)")
    print("   4. üîç Consulta de estado")
    print("   5. üé´ Verificaci√≥n de tickets")
    print("   6. üìÑ Descarga de CDR")
    print("   7. üìä Dashboard de estad√≠sticas")
    print("   8. üîÑ Operaciones en lote")
    print("=" * 50)
    
    # Verificar que el servidor est√© corriendo
    try:
        response = requests.get(f"{BASE_URL}/health/", timeout=5)
        if response.status_code != 200:
            raise Exception("Servidor no responde correctamente")
    except Exception as e:
        print(f"\n‚ùå El servidor no est√° corriendo o no responde")
        print(f"   Error: {str(e)}")
        print(f"   Ejecuta: python manage.py runserver")
        return False
    
    print(f"\nüîç Selecciona el tipo de prueba:")
    print(f"   1. Prueba completa de integraci√≥n")
    print(f"   2. Solo health check")
    print(f"   3. Solo crear y enviar un comprobante")
    print(f"   4. Solo dashboard")
    print(f"   5. Solo operaciones en lote")
    
    try:
        opcion = input(f"\nIngresa opci√≥n (1-5) [1]: ").strip() or "1"
        
        if opcion == "1":
            return full_integration_test()
        elif opcion == "2":
            return test_health_check()
        elif opcion == "3":
            comprobante_id = create_test_comprobante()
            if comprobante_id:
                test_send_to_sunat(comprobante_id)
                test_check_status(comprobante_id)
            return comprobante_id is not None
        elif opcion == "4":
            return test_sunat_dashboard() is not None
        elif opcion == "5":
            test_bulk_operations()
            test_pending_tickets()
            return True
        else:
            print("‚ùå Opci√≥n inv√°lida")
            return False
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è  Prueba interrumpida por el usuario")
        return False
    except Exception as e:
        print(f"\n‚ùå Error en prueba: {str(e)}")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)